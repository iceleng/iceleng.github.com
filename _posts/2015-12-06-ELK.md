---
layout: post
title:  ELK学习
categories: [elk]
---

2015-12-16
===
关于从snapshot中恢复数据的尝试，根据官方文档步骤如下：
---
1.   在elasticsearch中配置repo变量（原始的配置文档是没有这部分内容的）
	···iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ cat ../config/elasticsearoh.yml | grep rep 
	#ice add shared file system reposityory 2015-12-15
	path.repo: ["/home/iceleng/developerTools/elasticsearch-2.1.0/repo"]···
2.    在elasticsearch中注册snapshot（必须有前面指定的path.repo）
	iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ curl -XPUT 'http://localhost:9200/_snapshot/my_backup' -d '{"type":"fs","settings":{"location":"/home/iceleng/developerTools/elasticsearch-2.1.0/repo","compress":true}}'
	{"acknowledged":true}
3.    查看snapshot
	iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ curl localhost:9200/_snapshot
{"my_backup":{"type":"fs","settings":{"compress":"true","location":"/home/iceleng/developerTools/elasticsearch-2.1.0/repo"}}}iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ curl localhost:9200/_snapshot?pretty
	{
	  "my_backup" : {
	    "type" : "fs",
	    "settings" : {
	      "compress" : "true",
	      "location" : "/home/iceleng/developerTools/elasticsearch-2.1.0/repo"
	    }
	  }
	}
4. 将kibana4教程中提到的twitter数据和bank数据的相关文件copy到repo目录
5. 查看拷贝到repo目录中的文件
	iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ ls
	index  indices  metadata-v1  snapshot-v1
6. 根据命名规则，可以知道这个snapshot的名字是v1
7. 将snapshot的数据restore到index
 	iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ curl -XPOST http://localhost:9200/_snapshot/my_backup/v1/_restore
8. 将当前index创建snapshot
	iceleng@ubuntu:~/developerTools/elasticsearch-2.1.0/repo$ curl -XPOST http://localhost:9200/_snapshot/my_backup/ice_snapshot?wait_for_competion=true





#ELK相关资料

##Elk
Elastic中文社区
http://elasticsearch.cn/

##kibana4 教程
https://www.timroes.de/2015/02/07/kibana-4-tutorial-part-3-visualize/

##ogstash自定义插件和资料
http://blog.csdn.net/earbao/article/details/49335217

##Logstash 最佳实践
http://udn.yyuap.com/doc/logstash-best-practice-cn/index.html

##运维生存时间 elk文章
http://www.ttlsa.com/log-system/elk/

##nginx带upstream信息的log配置
	log_format  combine '$remote_addr - $remote_user [$time_local] "$request" $http_host ' 
	'$status $body_bytes_sent "$http_referer" '
	'"$http_user_agent" "$http_x_forwarded_for" '
	'$upstream_addr $upstream_status $upstream_cache_status "$upstream_http_content_type" $upstream_response_time > $request_time';


##logstash nginx配置文件
	input{
	  stdin{}
	  file{
			type=>"nginx-access"
	    path=>"/var/log/nginx/iceleng.access.log"
	    start_position=>"beginning"
	  }
	}
	filter{
		grok{
			#patterns_dir=>"../patterns"
			#match=>{"message"=>"%{NGINXACCESS}"}
	    match =>{"message"=>"%{IPORHOST:client_ip} - - \[%{HTTPDATE:timestamp}\] \"(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:http_version})?|-)\" %{IPORHOST:domain} %{NUMBER:response} (?:%{NUMBER:bytes}|-) %{QS:referrer} %{QS:agent} (%{QS:x_forword}|-) (%{URIHOST:upstream_host}|-) (%{NUMBER:upstream_response}|-) (%{WORD:upstream_cache_status}|-) %{QS:upstream_content_type} (%{BASE16FLOAT:upstream_response_time}|-) > (%{BASE16FLOAT:request_time}|-)"}
	  }
	  date {
	    match => ["timestamp" , "dd/MMM/YYYY:HH:mm:ss Z"]
	  }
	}
	output{
	  stdout{}
	  elasticsearch{
	    hosts=>"192.168.1.7"
	  }
	}


===============================

	安装license
	./plugin install license-> Installing license...
	Trying https://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/license/2.1.0/license-2.1.0.zip ...
	Downloading .......DONE
	Verifying https://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/license/2.1.0/license-2.1.0.zip checksums if available ...
	Downloading .DONE
	Installed license into /home/iceleng/dev/elasticsearch-2.1.0/plugins/license
	
	安装es的marvel插件
	iceleng@iceleng-desktop ~/dev/elasticsearch-2.1.0/bin $ ./plugin install marvel-agent
	-> Installing marvel-agent...
	Trying https://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/marvel-agent/2.1.0/marvel-agent-2.1.0.zip ...
	Downloading ..........DONE
	Verifying https://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/marvel-agent/2.1.0/marvel-agent-2.1.0.zip checksums if available ...
	Downloading .DONE
	Installed marvel-agent into /home/iceleng/dev/elasticsearch-2.1.0/plugins/marvel-agent
	
	安装kibana的插件
	iceleng@iceleng-desktop ~/dev/kibana-4.3.0-linux-x86/bin $ ./kibana plugin --install elasticsearch/marvel/latest
	Installing marvel
	Attempting to extract from https://download.elastic.co/elasticsearch/marvel/marvel-latest.tar.gz
	Downloading 1497374 bytes....................
	Extraction complete
	Optimizing and caching browser bundles...
	Plugin installation complete
	
	iceleng@iceleng-desktop ~/dev/kibana-4.3.0-linux-x86 $ ls 
	bin     installedPlugins  node          optimize      README.txt  webpackShims
	config  LICENSE.txt       node_modules  package.json  src

--------------------------

Elastic License

    发件人：support@elastic.co保存到地址簿
    收件人：iceprogrammer@sohu.com
    时　间：2015年12月13日 下午8:40:11

	Thank you for registering for a free license! This Basic license expires on December 13, 2016.
	
	To download your license, please go to:
	
	--> http://license.elastic.co/registration/download/65c0f940-5528-41ac-acc5-0cfadb21327f
	
	For license installation instructions:
	
	--> https://www.elastic.co/guide/en/marvel/current/license-management.html
	
	If you have any questions or issues, please visit us on the forums: https://discuss.elastic.co/ or reach out to us directly at info@elastic.co.
	
	Best,
	The Elastic Team







